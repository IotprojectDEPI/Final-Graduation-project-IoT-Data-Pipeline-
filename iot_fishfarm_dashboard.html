<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Fish Farm Dashboard - Real-Time Database Integration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0099CC;
            --secondary: #00C4B3;
            --alert: #FF6F61;
            --warning: #FFB74D;
            --success: #48bb78;
            --bg-light: #F7FAFC;
            --bg-dark: #1A1A1A;
            --card-light: #FFFFFF;
            --card-dark: #2D3748;
            --text-light: #2D3748;
            --text-dark: #E2E8F0;
            --border-light: #E2E8F0;
            --border-dark: #4A5568;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .connection-banner {
            background: var(--alert);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            animation: pulse 2s infinite;
        }

        .connection-banner.connected {
            background: var(--success);
            display: block;
        }

        .connection-banner.disconnected {
            background: var(--alert);
            display: block;
        }

        .header {
            background: var(--card-light);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        body.dark-mode .header {
            background: var(--card-dark);
        }

        .header-left h1 {
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .header-info {
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #718096;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: var(--alert);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        select, button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select {
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            color: var(--text-light);
        }

        body.dark-mode select {
            background: var(--bg-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        button {
            background: var(--primary);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 153, 204, 0.3);
        }

        .btn-pause { background: var(--warning); }
        .btn-export { background: var(--success); }
        .btn-reset { background: #667eea; }
        .btn-theme { background: #f56565; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-light);
            padding: 24px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .stat-card {
            background: var(--card-dark);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-icon {
            font-size: 28px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: baseline;
            gap: 6px;
            flex-wrap: wrap;
        }

        .stat-unit {
            font-size: 16px;
            font-weight: 500;
            color: #718096;
        }

        .grade-badge {
            font-size: 14px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 8px;
            margin-left: 8px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .grade-A { background: #48bb78; color: white; }
        .grade-B { background: #68d391; color: white; }
        .grade-C { background: #fbbf24; color: white; }
        .grade-D { background: #f56565; color: white; }
        .grade-E { background: #e53e3e; color: white; }
        .grade-F { background: #c53030; color: white; }
        .grade-FF { background: #9b2c2c; color: white; }
        .grade-FFF { background: #63171b; color: white; }
        .grade-NA { background: #a0aec0; color: white; }

        .stat-range {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #a0aec0;
            padding: 10px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-top: 10px;
        }

        body.dark-mode .stat-range {
            background: rgba(0, 0, 0, 0.2);
        }

        .sparkline {
            width: 100%;
            height: 40px;
            margin-top: 10px;
        }

        .status-normal { color: var(--success); }
        .status-warning { color: var(--warning); }
        .status-critical { 
            color: var(--alert);
            animation: alertPulse 1.5s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: var(--card-light);
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode .chart-card {
            background: var(--card-dark);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
        }

        .chart-badge {
            padding: 4px 12px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .chart-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .chart-toggle {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border: 1.5px solid #cbd5e0;
            background: white;
            color: #4a5568;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chart-toggle.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        body.dark-mode .chart-toggle {
            background: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        body.dark-mode .chart-toggle.active {
            background: var(--primary);
            color: white;
        }

        .insights-section {
            margin-bottom: 25px;
        }

        .insights-panel {
            background: linear-gradient(135deg, rgba(0, 153, 204, 0.05), rgba(0, 196, 179, 0.05));
            padding: 30px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--primary);
        }

        body.dark-mode .insights-panel {
            background: linear-gradient(135deg, rgba(0, 153, 204, 0.1), rgba(0, 196, 179, 0.1));
        }

        .insights-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .insights-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .insights-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .insight-box {
            background: var(--card-light);
            padding: 20px;
            border-radius: 12px;
        }

        body.dark-mode .insight-box {
            background: var(--card-dark);
        }

        .insight-box h3 {
            font-size: 14px;
            color: var(--primary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-box ul {
            list-style: none;
            padding: 0;
        }

        .insight-box li {
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-mode .insight-box li {
            border-color: var(--border-dark);
        }

        .insight-box li:last-child {
            border-bottom: none;
        }

        .health-score {
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            margin: 20px 0;
        }

        .health-label {
            text-align: center;
            font-size: 14px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .alerts-section {
            margin-bottom: 25px;
        }

        .alerts-panel {
            background: var(--card-light);
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode .alerts-panel {
            background: var(--card-dark);
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-light);
        }

        body.dark-mode .alerts-header {
            border-color: var(--border-dark);
        }

        .alerts-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-count {
            background: var(--alert);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 16px;
            background: rgba(255, 111, 97, 0.1);
            border-left: 4px solid var(--alert);
            border-radius: 10px;
            margin-bottom: 12px;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .alert-fish {
            font-weight: 700;
            color: var(--alert);
            font-size: 14px;
            text-transform: capitalize;
        }

        .alert-param {
            margin-top: 4px;
            font-size: 12px;
            color: #718096;
        }

        .alert-value {
            font-weight: 700;
            font-size: 16px;
            padding: 6px 12px;
            background: rgba(255, 111, 97, 0.2);
            border-radius: 8px;
        }

        .alert-time {
            color: #a0aec0;
            font-size: 11px;
            margin-top: 8px;
        }

        .no-alerts {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .table-section {
            margin-bottom: 25px;
        }

        .table-container {
            background: var(--card-light);
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            overflow-x: auto;
        }

        body.dark-mode .table-container {
            background: var(--card-dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
        }

        body.dark-mode td {
            border-color: var(--border-dark);
        }

        tr:hover {
            background: rgba(0, 153, 204, 0.05);
        }

        .cell-warning {
            background: rgba(255, 183, 77, 0.2);
            color: var(--warning);
            font-weight: 600;
        }

        .cell-critical {
            background: rgba(255, 111, 97, 0.2);
            color: var(--alert);
            font-weight: 600;
        }

        .footer {
            text-align: center;
            padding: 25px;
            color: #a0aec0;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="connection-banner" id="connectionBanner">
            üî¥ Disconnected from server - Retrying...
        </div>

        <div class="header">
            <div class="header-left">
                <h1>üêü IoT Fish Farm Real-Time Dashboard</h1>
                <div class="subtitle">Live data from SQLite Database via Flask API - Updates every 5 seconds</div>
            </div>
            <div class="header-info">
                <div class="info-item">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="lastUpdate">Connecting to server...</span>
                </div>
                <div class="info-item">
                    üïê <span id="currentTime"></span>
                </div>
                <div class="info-item">
                    ‚è±Ô∏è Uptime: <span id="uptime">0:00:00</span>
                </div>
            </div>
        </div>

        <div class="header">
            <div class="controls">
                <select id="fishSelector">
                    <option value="all">All Species</option>
                    <option value="pangas">Pangas</option>
                    <option value="rui">Rui</option>
                    <option value="silverCup">Silver Cup</option>
                    <option value="koi">Koi</option>
                    <option value="tilapia">Tilapia</option>
                    <option value="shrimp">Shrimp</option>
                    <option value="sing">Sing</option>
                    <option value="prawn">Prawn</option>
                    <option value="katla">Katla</option>
                    <option value="karpio">Karpio</option>
                    <option value="magur">Magur</option>
                </select>
                <select id="intervalSelector">
                    <option value="5000">5s Update</option>
                    <option value="10000">10s Update</option>
                    <option value="30000">30s Update</option>
                </select>
                <button id="pauseBtn" class="btn-pause">‚è∏ Pause</button>
                <button id="exportBtn" class="btn-export">üì• Export CSV</button>
                <button id="resetBtn" class="btn-reset">üîÑ Reset</button>
                <button id="themeBtn" class="btn-theme">üåô Dark</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Temperature</span>
                    <span class="stat-icon" id="tempIcon">üå°Ô∏è</span>
                </div>
                <div class="stat-value">
                    <span id="tempValue">--</span>
                    <span class="stat-unit">¬∞C</span>
                    <span class="grade-badge grade-NA" id="tempGrade">-</span>
                </div>
                <canvas class="sparkline" id="tempSparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="tempMin">--</strong></span>
                    <span>Max: <strong id="tempMax">--</strong></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Humidity</span>
                    <span class="stat-icon" id="humidityIcon">üíß</span>
                </div>
                <div class="stat-value">
                    <span id="humidityValue">--</span>
                    <span class="stat-unit">%</span>
                    <span class="grade-badge grade-NA" id="humidityGrade">-</span>
                </div>
                <canvas class="sparkline" id="humiditySparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="humidityMin">--</strong></span>
                    <span>Max: <strong id="humidityMax">--</strong></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">pH Level</span>
                    <span class="stat-icon" id="phIcon">‚öóÔ∏è</span>
                </div>
                <div class="stat-value">
                    <span id="phValue">--</span>
                    <span class="grade-badge grade-NA" id="phGrade">-</span>
                </div>
                <canvas class="sparkline" id="phSparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="phMin">--</strong></span>
                    <span>Max: <strong id="phMax">--</strong></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Light</span>
                    <span class="stat-icon" id="lightIcon">üí°</span>
                </div>
                <div class="stat-value">
                    <span id="lightValue">--</span>
                    <span class="stat-unit">lux</span>
                    <span class="grade-badge grade-NA" id="lightGrade">-</span>
                </div>
                <canvas class="sparkline" id="lightSparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="lightMin">--</strong></span>
                    <span>Max: <strong id="lightMax">--</strong></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Turbidity</span>
                    <span class="stat-icon" id="turbidityIcon">üëÅÔ∏è</span>
                </div>
                <div class="stat-value">
                    <span id="turbidityValue">--</span>
                    <span class="stat-unit">NTU</span>
                    <span class="grade-badge grade-NA" id="turbidityGrade">-</span>
                </div>
                <canvas class="sparkline" id="turbiditySparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="turbidityMin">--</strong></span>
                    <span>Max: <strong id="turbidityMax">--</strong></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Water Temp</span>
                    <span class="stat-icon" id="waterTempIcon">üåä</span>
                </div>
                <div class="stat-value">
                    <span id="waterTempValue">--</span>
                    <span class="stat-unit">¬∞C</span>
                    <span class="grade-badge grade-NA" id="waterTempGrade">-</span>
                </div>
                <canvas class="sparkline" id="waterTempSparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="waterTempMin">--</strong></span>
                    <span>Max: <strong id="waterTempMax">--</strong></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Conductivity</span>
                    <span class="stat-icon" id="condIcon">‚ö°</span>
                </div>
                <div class="stat-value">
                    <span id="condValue">--</span>
                    <span class="stat-unit">mS/cm</span>
                    <span class="grade-badge grade-NA" id="condGrade">-</span>
                </div>
                <canvas class="sparkline" id="condSparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="condMin">--</strong></span>
                    <span>Max: <strong id="condMax">--</strong></span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">TDS</span>
                    <span class="stat-icon" id="tdsIcon">üß™</span>
                </div>
                <div class="stat-value">
                    <span id="tdsValue">--</span>
                    <span class="stat-unit">ppm</span>
                    <span class="grade-badge grade-NA" id="tdsGrade">-</span>
                </div>
                <canvas class="sparkline" id="tdsSparkline"></canvas>
                <div class="stat-range">
                    <span>Min: <strong id="tdsMin">--</strong></span>
                    <span>Max: <strong id="tdsMax">--</strong></span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Temperature Trends</div>
                    <div class="chart-controls">
                        <button class="chart-toggle active" data-mode="value" data-chart="temp">Raw</button>
                        <button class="chart-toggle" data-mode="grade" data-chart="temp">Grade</button>
                    </div>
                    <div class="chart-badge">Live DB</div>
                </div>
                <canvas id="tempChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">pH Levels</div>
                    <div class="chart-controls">
                        <button class="chart-toggle active" data-mode="value" data-chart="ph">Raw</button>
                        <button class="chart-toggle" data-mode="grade" data-chart="ph">Grade</button>
                    </div>
                    <div class="chart-badge">Live DB</div>
                </div>
                <canvas id="phChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Turbidity Monitoring</div>
                    <div class="chart-controls">
                        <button class="chart-toggle active" data-mode="value" data-chart="turb">Raw</button>
                        <button class="chart-toggle" data-mode="grade" data-chart="turb">Grade</button>
                    </div>
                    <div class="chart-badge">Live DB</div>
                </div>
                <canvas id="turbChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Total Dissolved Solids</div>
                    <div class="chart-controls">
                        <button class="chart-toggle active" data-mode="value" data-chart="tds">Raw</button>
                        <button class="chart-toggle" data-mode="grade" data-chart="tds">Grade</button>
                    </div>
                    <div class="chart-badge">Live DB</div>
                </div>
                <canvas id="tdsChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Light Intensity</div>
                    <div class="chart-controls">
                        <button class="chart-toggle active" data-mode="value" data-chart="light">Raw</button>
                        <button class="chart-toggle" data-mode="grade" data-chart="light">Grade</button>
                    </div>
                    <div class="chart-badge">Live DB</div>
                </div>
                <canvas id="lightChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Water Temperature</div>
                    <div class="chart-controls">
                        <button class="chart-toggle active" data-mode="value" data-chart="waterTemp">Raw</button>
                        <button class="chart-toggle" data-mode="grade" data-chart="waterTemp">Grade</button>
                    </div>
                    <div class="chart-badge">Live DB</div>
                </div>
                <canvas id="waterTempChart"></canvas>
            </div>
        </div>

        <!-- <div class="insights-section">
            <div class="insights-panel">
                <div class="insights-header">
                    <div class="insights-title">üß† AI Insights & Analysis</div>
                    <button class="refresh-btn" id="refreshInsights">üîÑ Refresh</button>
                </div>
                <div class="insights-content">
                    <div class="insight-box">
                        <h3>üìä Quick Summary</h3>
                        <p id="quickSummary">Fetching data from database...</p>
                    </div>
                    <div class="insight-box">
                        <h3>üîç Top Observations</h3>
                        <ul id="topObservations">
                            <li>Initializing...</li>
                        </ul>
                    </div>
                    <div class="insight-box">
                        <h3>‚ö†Ô∏è Detected Anomalies</h3>
                        <ul id="anomaliesList">
                            <li>No anomalies detected</li>
                        </ul>
                    </div>
                    <div class="insight-box">
                        <h3>üí° Recommendations</h3>
                        <ul id="recommendations">
                            <li>System operating normally</li>
                        </ul>
                    </div>
                    <div class="insight-box">
                        <h3>üìà Health Score</h3>
                        <div class="health-score status-normal" id="healthScore">100</div>
                        <div class="health-label">System Health</div>
                    </div>
                    <div class="insight-box">
                        <h3>üîÆ Short Forecast</h3>
                        <p id="forecast">Stable conditions expected</p>
                    </div>
                </div>
            </div>
        </div> -->

        <div class="alerts-section">
            <div class="alerts-panel">
                <div class="alerts-header">
                    <div class="alerts-title">
                        <span>‚ö†Ô∏è Alert Monitor</span>
                        <span class="alert-count" id="alertCount">0</span>
                    </div>
                </div>
                <div class="alerts-list" id="alertsList">
                    <div class="no-alerts">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <div>All systems operating normally</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-container">
                <h2 style="margin-bottom: 20px;">üìã Latest Readings from Database</h2>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Species</th>
                            <th>Temp</th>
                            <th>Grade</th>
                            <th>Humidity</th>
                            <th>Grade</th>
                            <th>Light</th>
                            <th>Grade</th>
                            <th>pH</th>
                            <th>Grade</th>
                            <th>Cond</th>
                            <th>Grade</th>
                            <th>Turb</th>
                            <th>Grade</th>
                            <th>Water T</th>
                            <th>Grade</th>
                            <th>TDS</th>
                            <th>Grade</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            üêü Fish Farm IoT Monitoring System ¬© 2025 | Egypt Vision 2030 | Real-Time Database Integration
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000/api/data';
        
        const GRADE_TO_VALUE = {
            'A': 5, 'B+': 4.5, 'B-': 4.2,
            'C+': 3.8, 'C-': 3.5,
            'D+': 3.0, 'D-': 2.7,
            'E+': 2.2, 'E-': 1.8,
            'F+': 1.3, 'F-': 1.0,
            'F++': 0.5, 'F--': 0.2,
            'N/A': null
        };

        const GRADE_COLORS = {
            'A': '#48bb78',
            'B+': '#68d391', 'B-': '#68d391',
            'C+': '#fbbf24', 'C-': '#fbbf24',
            'D+': '#f56565', 'D-': '#f56565',
            'E+': '#e53e3e', 'E-': '#e53e3e',
            'F+': '#c53030', 'F-': '#c53030',
            'F++': '#9b2c2c', 'F--': '#63171b',
            'N/A': '#a0aec0'
        };

        const PARAM_MAP = {
            temp: 'temperature',
            ph: 'pH',
            turb: 'turbidity',
            tds: 'TDS',
            light: 'light',
            waterTemp: 'water_temp'
        };

        let chartModes = {
            temp: 'value', ph: 'value', turb: 'value',
            tds: 'value', light: 'value', waterTemp: 'value'
        };

        const THRESHOLDS = {
            temperature: {min:20,max:30,critical_min:15,critical_max:35},
            humidity: {min:35,max:85,critical_min:30,critical_max:90},
            light: {min:100,max:800,critical_min:50,critical_max:900},
            pH: {min:6.5,max:8.0,critical_min:6.0,critical_max:8.5},
            electrical_conductivity: {min:0.5,max:2.0,critical_min:0.3,critical_max:2.5},
            turbidity: {min:0,max:8,critical_min:0,critical_max:12},
            water_temp: {min:22,max:28,critical_min:19,critical_max:31},
            TDS: {min:200,max:400,critical_min:150,critical_max:500}
        };

        let currentData = [];
        let historicalData = [];
        let alerts = [];
        let isPaused = false;
        let selectedFish = 'all';
        let updateInterval = 5000;
        let intervalId = null;
        let insightsIntervalId = null;
        let charts = {};
        let sparklines = {};
        let startTime = Date.now();
        let isConnected = false;
        let retryCount = 0;
        let websocket = null;
        let wsReconnectTimer = null;

        // function connectWebSocket() {
        //     const WS_URL = 'ws://127.0.0.1:5000/alerts';
        //     console.log('üîå Connecting to WebSocket:', WS_URL);
            
        //     try {
        //         websocket = new WebSocket(WS_URL);
                
        //         websocket.onopen = () => {
        //             console.log('‚úÖ WebSocket connected - listening for Kafka alerts');
        //             if (wsReconnectTimer) {
        //                 clearTimeout(wsReconnectTimer);
        //                 wsReconnectTimer = null;
        //             }
        //         };
                
        //         websocket.onmessage = (event) => {
        //             console.log('üì© Kafka alert received:', event.data);
                    
        //             try {
        //                 const alert = JSON.parse(event.data);
                        
        //                 // Add Kafka alert to the alerts array
        //                 alerts.unshift({
        //                     fish: alert.fish || 'Unknown',
        //                     parameter: alert.sensor || 'N/A',
        //                     value: alert.value || 'N/A',
        //                     status: 'critical',
        //                     time: new Date().toLocaleTimeString(),
        //                     timestamp: Date.now(),
        //                     action: alert.alert || 'Monitor system'
        //                 });
                        
        //                 // Keep only last 20 alerts
        //                 if (alerts.length > 20) alerts = alerts.slice(0, 20);
                        
        //                 // Update the alerts display
        //                 updateAlertsDisplay();
                        
        //             } catch (err) {
        //                 console.error('‚ùå Failed to parse alert:', err);
        //             }
        //         };
                
        //         websocket.onerror = (error) => {
        //             console.error('‚ùå WebSocket error:', error);
        //         };
                
        //         websocket.onclose = () => {
        //             console.log('üîå WebSocket disconnected - reconnecting in 5s');
        //             websocket = null;
        //             wsReconnectTimer = setTimeout(connectWebSocket, 5000);
        //         };
                
        //     } catch (err) {
        //         console.error('‚ùå WebSocket connection failed:', err);
        //         wsReconnectTimer = setTimeout(connectWebSocket, 5000);
        //     }
        // }

        async function fetchRealData() {
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    console.log('‚úÖ Data fetched:', result.data.length, 'records');
                    updateConnectionStatus(true);
                    retryCount = 0;
                    return result.data;
                } else {
                    console.warn('‚ö†Ô∏è No data returned');
                    updateConnectionStatus(false);
                    return currentData.length > 0 ? currentData : [];
                }
            } catch (err) {
                console.error('‚ùå Fetch failed:', err.message);
                updateConnectionStatus(false);
                retryCount++;
                return currentData.length > 0 ? currentData : [];
            }
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const banner = document.getElementById('connectionBanner');
            const statusDot = document.getElementById('statusDot');
            
            if (connected) {
                banner.className = 'connection-banner connected';
                banner.innerHTML = '‚úÖ Connected to Flask API - Receiving real-time data';
                statusDot.className = 'status-dot';
            } else {
                banner.className = 'connection-banner disconnected';
                banner.innerHTML = `üî¥ Disconnected - Retry ${retryCount}. Check Flask server on port 5000`;
                statusDot.className = 'status-dot disconnected';
            }
        }

        function getStatus(value, param) {
            if (!THRESHOLDS[param] || value === null || value === undefined) return 'normal';
            const t = THRESHOLDS[param];
            if (value < t.critical_min || value > t.critical_max) return 'critical';
            if (value < t.min || value > t.max) return 'warning';
            return 'normal';
        }

        function getGradeClass(grade) {
            if (!grade || grade === 'N/A') return 'grade-NA';
            if (grade === 'A') return 'grade-A';
            if (grade.startsWith('B')) return 'grade-B';
            if (grade.startsWith('C')) return 'grade-C';
            if (grade.startsWith('D')) return 'grade-D';
            if (grade.startsWith('E')) return 'grade-E';
            if (grade === 'F+' || grade === 'F-') return 'grade-F';
            if (grade === 'F++') return 'grade-FF';
            if (grade === 'F--') return 'grade-FFF';
            return 'grade-NA';
        }

        function checkThresholds(data) {
            if (!data || data.length === 0) return;
            
            data.forEach(tank => {
                ['temperature', 'pH', 'turbidity', 'TDS'].forEach(param => {
                    const value = tank[param];
                    if (value === undefined || value === null) return;
                    
                    const status = getStatus(value, param);
                    if (status !== 'normal') {
                        alerts.unshift({
                            fish: tank.fish || 'Unknown',
                            parameter: param,
                            value: value.toFixed(2),
                            status: status,
                            time: new Date().toLocaleTimeString(),
                            timestamp: Date.now(),
                            action: getRecommendedAction(param, status)
                        });
                    }
                });
            });

            if (alerts.length > 20) alerts = alerts.slice(0, 20);
            updateAlertsDisplay();
        }

        function getRecommendedAction(param, status) {
            const actions = {
                temperature: 'Adjust heater/chiller system',
                pH: 'Check water chemistry and buffering',
                turbidity: 'Inspect filtration system',
                TDS: 'Consider partial water change'
            };
            return actions[param] || 'Monitor closely';
        }

        function updateAlertsDisplay() {
            const alertsList = document.getElementById('alertsList');
            const alertCount = document.getElementById('alertCount');
            
            alertCount.textContent = alerts.length;

            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="no-alerts"><div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div><div>All systems operating normally</div></div>';
                return;
            }

            let html = '';
            alerts.forEach(alert => {
                html += `<div class="alert-item">
                    <div class="alert-content">
                        <div style="flex: 1;">
                            <div class="alert-fish">üêü ${alert.fish}</div>
                            <div class="alert-param">${alert.parameter.toUpperCase()} - ${alert.status}</div>
                            <div class="alert-time">üïê ${alert.time} | ${alert.action}</div>
                        </div>
                        <div class="alert-value">${alert.value}</div>
                    </div>
                </div>`;
            });
            alertsList.innerHTML = html;
        }

        function initCharts() {
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: false,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: { grid: { display: false } }
                },
                animation: { duration: 500 }
            };

            function createChart(id, label, color) {
                const canvas = document.getElementById(id);
                if (!canvas) {
                    console.error('Canvas not found:', id);
                    return null;
                }
                return new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: label,
                            data: [],
                            borderColor: color,
                            backgroundColor: color + '20',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3
                        }]
                    },
                    options: chartConfig
                });
            }

            charts.temp = createChart('tempChart', 'Temperature', '#FF6B6B');
            charts.ph = createChart('phChart', 'pH', '#4ECDC4');
            charts.turb = createChart('turbChart', 'Turbidity', '#FFB74D');
            charts.tds = createChart('tdsChart', 'TDS', '#48BB78');
            charts.light = createChart('lightChart', 'Light', '#FFA726');
            charts.waterTemp = createChart('waterTempChart', 'Water Temp', '#42A5F5');
        }

        function initSparklines() {
            const sparkConfig = {
                responsive: false,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: { y: { display: false }, x: { display: false } },
                elements: { point: { radius: 0 } },
                animation: false
            };

            function createSparkline(id, color) {
                const canvas = document.getElementById(id);
                if (!canvas) {
                    console.error('Sparkline canvas not found:', id);
                    return null;
                }
                return new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            borderColor: color,
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: sparkConfig
                });
            }

            sparklines.temp = createSparkline('tempSparkline', '#FF6B6B');
            sparklines.humidity = createSparkline('humiditySparkline', '#4ECDC4');
            sparklines.ph = createSparkline('phSparkline', '#FFB74D');
            sparklines.light = createSparkline('lightSparkline', '#FFA726');
            sparklines.turbidity = createSparkline('turbiditySparkline', '#48BB78');
            sparklines.waterTemp = createSparkline('waterTempSparkline', '#42A5F5');
            sparklines.cond = createSparkline('condSparkline', '#9C27B0');
            sparklines.tds = createSparkline('tdsSparkline', '#F44336');
        }

        function updateStats() {
            if (!currentData || currentData.length === 0) return;
            
            const filteredData = selectedFish === 'all' 
                ? currentData 
                : currentData.filter(d => d.fish === selectedFish);

            if (filteredData.length === 0) return;

            updateStat('temperature', 'temp', '¬∞C', filteredData);
            updateStat('humidity', 'humidity', '%', filteredData);
            updateStat('pH', 'ph', '', filteredData);
            updateStat('light', 'light', ' lux', filteredData);
            updateStat('turbidity', 'turbidity', ' NTU', filteredData);
            updateStat('water_temp', 'waterTemp', '¬∞C', filteredData);
            updateStat('electrical_conductivity', 'cond', ' mS/cm', filteredData);
            updateStat('TDS', 'tds', ' ppm', filteredData);
        }

        function updateStat(param, prefix, unit, data) {
            const values = data.map(d => d[param]).filter(v => v !== undefined && v !== null && !isNaN(v));
            if (values.length === 0) return;
            
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const status = getStatus(avg, param);

            const gradeField = param + '_class';
            const grade = data[0][gradeField] || 'N/A';

            const valueEl = document.getElementById(prefix + 'Value');
            const minEl = document.getElementById(prefix + 'Min');
            const maxEl = document.getElementById(prefix + 'Max');
            
            if (valueEl) valueEl.textContent = avg.toFixed(2);
            if (minEl) minEl.textContent = min.toFixed(2);
            if (maxEl) maxEl.textContent = max.toFixed(2);
            
            const gradeBadge = document.getElementById(prefix + 'Grade');
            if (gradeBadge) {
                gradeBadge.textContent = grade;
                gradeBadge.className = 'grade-badge ' + getGradeClass(grade);
            }
            
            const icon = document.getElementById(prefix + 'Icon');
            if (icon) {
                icon.className = `stat-icon status-${status}`;
            }

            if (sparklines[prefix]) {
                sparklines[prefix].data.labels.push('');
                sparklines[prefix].data.datasets[0].data.push(avg);
                if (sparklines[prefix].data.labels.length > 10) {
                    sparklines[prefix].data.labels.shift();
                    sparklines[prefix].data.datasets[0].data.shift();
                }
                sparklines[prefix].update('none');
            }
        }

        function updateCharts() {
            if (!currentData || currentData.length === 0) return;
            
            const time = new Date().toLocaleTimeString();
            const filteredData = selectedFish === 'all' 
                ? currentData 
                : currentData.filter(d => d.fish === selectedFish);

            if (filteredData.length === 0) return;

            const stats = {
                temp: 0, ph: 0, turb: 0, tds: 0, light: 0, waterTemp: 0
            };

            filteredData.forEach(d => {
                stats.temp += d.temperature || 0;
                stats.ph += d.pH || 0;
                stats.turb += d.turbidity || 0;
                stats.tds += d.TDS || 0;
                stats.light += d.light || 0;
                stats.waterTemp += d.water_temp || 0;
            });

            Object.keys(stats).forEach(key => stats[key] /= filteredData.length);

            const firstRow = filteredData[0];

            historicalData.push({
                time,
                temp: stats.temp,
                ph: stats.ph,
                turb: stats.turb,
                tds: stats.tds,
                light: stats.light,
                waterTemp: stats.waterTemp,
                temperature_class: firstRow.temperature_class || 'N/A',
                pH_class: firstRow.pH_class || 'N/A',
                turbidity_class: firstRow.turbidity_class || 'N/A',
                TDS_class: firstRow.TDS_class || 'N/A',
                light_class: firstRow.light_class || 'N/A',
                water_temp_class: firstRow.water_temp_class || 'N/A'
            });

            if (historicalData.length > 20) historicalData.shift();

            const labels = historicalData.map(d => d.time);

            Object.keys(charts).forEach(chartId => {
                if (charts[chartId]) {
                    const mode = chartModes[chartId] || 'value';
                    updateChart(charts[chartId], labels, chartId, mode);
                }
            });
        }

        function updateChart(chart, labels, key, mode = 'value') {
            if (!chart) return;
            
            const dataset = chart.data.datasets[0];
            const param = PARAM_MAP[key];

            if (mode === 'grade') {
                const grades = historicalData.map(d => {
                    const grade = d[param + '_class'];
                    return grade && grade !== 'N/A' && GRADE_TO_VALUE[grade] !== undefined 
                        ? GRADE_TO_VALUE[grade] 
                        : null;
                });

                dataset.data = grades;
                dataset.label = 'Grade (A=5, F--=0)';
                dataset.borderColor = '#667eea';
                dataset.backgroundColor = 'rgba(102,126,234,0.1)';
                dataset.pointBackgroundColor = historicalData.map(d => {
                    const g = d[param + '_class'];
                    return GRADE_COLORS[g] || '#a0aec0';
                });
                dataset.pointRadius = 6;
                dataset.pointHoverRadius = 8;
                dataset.borderWidth = 3;

                chart.options.scales.y = {
                    min: 0, 
                    max: 5.5,
                    ticks: {
                        stepSize: 0.5,
                        callback: function(val) {
                            const gradeLabels = {
                                5:'A', 4.5:'B+', 4.2:'B-', 
                                3.8:'C+', 3.5:'C-',
                                3:'D+', 2.7:'D-', 
                                2.2:'E+', 1.8:'E-', 
                                1.3:'F+', 1:'F-', 
                                0.5:'F++', 0.2:'F--',
                                0:'Min'
                            };
                            return gradeLabels[val] || '';
                        }
                    },
                    grid: { color: 'rgba(0,0,0,0.08)' }
                };

                chart.options.plugins.tooltip.callbacks = {
                    label: function(ctx) {
                        const grade = historicalData[ctx.dataIndex][param + '_class'];
                        return `Grade: ${grade || 'N/A'}`;
                    }
                };
            } else {
                const rawValues = historicalData.map(d => {
                    const val = d[key];
                    return val !== undefined && val !== null ? val : null;
                });

                dataset.data = rawValues;
                dataset.label = param;
                
                const color = {
                    temp: '#FF6B6B',
                    ph: '#4ECDC4',
                    turb: '#FFB74D',
                    tds: '#48BB78',
                    light: '#FFA726',
                    waterTemp: '#42A5F5'
                }[key] || '#999';
                
                dataset.borderColor = color;
                dataset.backgroundColor = color + '20';
                dataset.pointBackgroundColor = color;
                dataset.pointRadius = 4;
                dataset.pointHoverRadius = 6;
                dataset.borderWidth = 2;

                chart.options.scales.y = { 
                    beginAtZero: false,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: {
                        callback: function(val) {
                            return typeof val === 'number' ? val.toFixed(1) : val;
                        }
                    }
                };

                chart.options.plugins.tooltip.callbacks = {
                    label: function(ctx) {
                        return `${param}: ${ctx.parsed.y ? ctx.parsed.y.toFixed(2) : 'N/A'}`;
                    }
                };
            }

            chart.data.labels = labels;
            chart.update();
        }

        function updateTable() {
            if (!currentData || currentData.length === 0) return;
            
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            
            let html = '';
            
            currentData.slice(0, 11).forEach(tank => {
                const tempStatus = getStatus(tank.temperature, 'temperature');
                const phStatus = getStatus(tank.pH, 'pH');
                const turbStatus = getStatus(tank.turbidity, 'turbidity');
                const tdsStatus = getStatus(tank.TDS, 'TDS');

                html += `<tr>
                    <td style="text-transform: capitalize; font-weight: 600;">${tank.fish || 'N/A'}</td>
                    <td class="cell-${tempStatus}">${(tank.temperature || 0).toFixed(2)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.temperature_class)}">${tank.temperature_class || 'N/A'}</span></td>
                    <td>${(tank.humidity || 0).toFixed(2)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.humidity_class)}">${tank.humidity_class || 'N/A'}</span></td>
                    <td>${(tank.light || 0).toFixed(2)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.light_class)}">${tank.light_class || 'N/A'}</span></td>
                    <td class="cell-${phStatus}">${(tank.pH || 0).toFixed(2)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.pH_class)}">${tank.pH_class || 'N/A'}</span></td>
                    <td>${(tank.electrical_conductivity || 0).toFixed(3)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.electrical_conductivity_class)}">${tank.electrical_conductivity_class || 'N/A'}</span></td>
                    <td class="cell-${turbStatus}">${(tank.turbidity || 0).toFixed(2)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.turbidity_class)}">${tank.turbidity_class || 'N/A'}</span></td>
                    <td>${(tank.water_temp || 0).toFixed(2)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.water_temp_class)}">${tank.water_temp_class || 'N/A'}</span></td>
                    <td class="cell-${tdsStatus}">${(tank.TDS || 0).toFixed(0)}</td>
                    <td><span class="grade-badge ${getGradeClass(tank.TDS_class)}">${tank.TDS_class || 'N/A'}</span></td>
                    <td style="font-size: 11px; color: #718096;">${tank.timestamp || new Date().toLocaleTimeString()}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        function calculateHealthScore() {
            let score = 100;
            const recentAlerts = alerts.filter(a => Date.now() - a.timestamp < 60000);
            
            recentAlerts.forEach(alert => {
                if (alert.status === 'critical') score -= 10;
                else if (alert.status === 'warning') score -= 5;
            });

            return Math.max(0, score);
        }

        function generateInsights() {
            if (!currentData || currentData.length === 0) {
                const summaryEl = document.getElementById('quickSummary');
                if (summaryEl) summaryEl.textContent = 'Waiting for data...';
                return;
            }

            const healthScore = calculateHealthScore();
            const scoreEl = document.getElementById('healthScore');
            if (scoreEl) {
                scoreEl.textContent = healthScore;
                scoreEl.className = `health-score status-${healthScore >= 80 ? 'normal' : healthScore >= 60 ? 'warning' : 'critical'}`;
            }

            let summary = healthScore >= 80 
                ? '‚úÖ All systems operating within normal parameters' 
                : healthScore >= 60 
                ? '‚ö†Ô∏è Minor issues detected - monitoring required' 
                : 'üö® Critical alerts active - immediate attention needed';
            
            const summaryEl = document.getElementById('quickSummary');
            if (summaryEl) summaryEl.textContent = summary;

            const obs = [];
            currentData.forEach(tank => {
                if (tank.pH && tank.pH > 7.8) obs.push(`${tank.fish}: pH trending high (${tank.pH.toFixed(2)})`);
                if (tank.turbidity && tank.turbidity > 8) obs.push(`${tank.fish}: High turbidity (${tank.turbidity.toFixed(1)} NTU)`);
                if (tank.temperature && tank.temperature < 21) obs.push(`${tank.fish}: Low temperature (${tank.temperature.toFixed(1)}¬∞C)`);
            });
            
            const obsList = document.getElementById('topObservations');
            if (obsList) {
                obsList.innerHTML = obs.length > 0 
                    ? obs.slice(0, 3).map(o => `<li>${o}</li>`).join('') 
                    : '<li>All metrics within expected ranges</li>';
            }

            const anomalies = alerts.filter(a => a.status === 'critical').slice(0, 3);
            const anomList = document.getElementById('anomaliesList');
            if (anomList) {
                anomList.innerHTML = anomalies.length > 0
                    ? anomalies.map(a => `<li><strong>${a.fish}</strong>: ${a.parameter} = ${a.value}</li>`).join('')
                    : '<li>No critical anomalies detected</li>';
            }

            const recs = [];
            if (alerts.some(a => a.parameter === 'pH')) recs.push('Monitor water chemistry');
            if (alerts.some(a => a.parameter === 'turbidity')) recs.push('Clean filtration systems');
            if (alerts.some(a => a.parameter === 'temperature')) recs.push('Check climate control');
            if (recs.length === 0) recs.push('Continue regular monitoring');

            const recsEl = document.getElementById('recommendations');
            if (recsEl) {
                recsEl.innerHTML = recs.slice(0, 3).map(r => `<li>${r}</li>`).join('');
            }

            const trend = historicalData.length > 5 
                ? (historicalData[historicalData.length - 1].temp - historicalData[historicalData.length - 5].temp) 
                : 0;
            
            let forecast = 'Conditions expected to remain stable';
            if (Math.abs(trend) > 0.5) {
                forecast = trend > 0 
                    ? `Temperature trending upward (+${trend.toFixed(2)}¬∞C)`
                    : `Temperature trending downward (${trend.toFixed(2)}¬∞C)`;
            }
            const forecastEl = document.getElementById('forecast');
            if (forecastEl) forecastEl.textContent = forecast;
        }

        async function updateDashboard() {
            if (!isPaused) {
                const newData = await fetchRealData();
                if (newData && newData.length > 0) {
                    currentData = newData;
                    checkThresholds(currentData);
                    // connectWebSocket();
                }
            }
            updateStats();
            updateCharts();
            updateTable();
            
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            }
            
            const currentTimeEl = document.getElementById('currentTime');
            if (currentTimeEl) {
                currentTimeEl.textContent = new Date().toLocaleTimeString();
            }
            
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const uptimeEl = document.getElementById('uptime');
            if (uptimeEl) {
                uptimeEl.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        function exportCSV() {
            if (!currentData || currentData.length === 0) {
                alert('No data to export');
                return;
            }

            let csv = 'Species,Temperature,Temp_Grade,Humidity,Humidity_Grade,Light,Light_Grade,pH,pH_Grade,Conductivity,Cond_Grade,Turbidity,Turb_Grade,Water_Temp,WT_Grade,TDS,TDS_Grade,Timestamp\n';
            currentData.forEach(row => {
                csv += `${row.fish || 'N/A'},${row.temperature || 0},${row.temperature_class || 'N/A'},${row.humidity || 0},${row.humidity_class || 'N/A'},${row.light || 0},${row.light_class || 'N/A'},${row.pH || 0},${row.pH_class || 'N/A'},${row.electrical_conductivity || 0},${row.electrical_conductivity_class || 'N/A'},${row.turbidity || 0},${row.turbidity_class || 'N/A'},${row.water_temp || 0},${row.water_temp_class || 'N/A'},${row.TDS || 0},${row.TDS_class || 'N/A'},${row.timestamp || new Date().toISOString()}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fishfarm-data-${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function resetData() {
            historicalData = [];
            alerts = [];
            startTime = Date.now();
            updateDashboard();
            generateInsights();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            const themeBtn = document.getElementById('themeBtn');
            if (themeBtn) {
                themeBtn.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
            }
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        const fishSelector = document.getElementById('fishSelector');
        if (fishSelector) {
            fishSelector.addEventListener('change', e => {
                selectedFish = e.target.value;
                historicalData = [];
                updateDashboard();
            });
        }

        const intervalSelector = document.getElementById('intervalSelector');
        if (intervalSelector) {
            intervalSelector.addEventListener('change', e => {
                updateInterval = parseInt(e.target.value);
                if (intervalId) clearInterval(intervalId);
                intervalId = setInterval(() => {
                    updateDashboard().catch(err => console.error('Update error:', err));
                }, updateInterval);
            });
        }

        const pauseBtn = document.getElementById('pauseBtn');
        if (pauseBtn) {
            pauseBtn.addEventListener('click', function() {
                isPaused = !isPaused;
                this.textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏ Pause';
            });
        }

        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', exportCSV);
        }

        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', resetData);
        }

        const themeBtn = document.getElementById('themeBtn');
        if (themeBtn) {
            themeBtn.addEventListener('click', toggleTheme);
        }

        const refreshInsights = document.getElementById('refreshInsights');
        if (refreshInsights) {
            refreshInsights.addEventListener('click', generateInsights);
        }

        document.querySelectorAll('.chart-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartId = this.dataset.chart;
                const mode = this.dataset.mode;
                
                this.parentElement.querySelectorAll('.chart-toggle').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                chartModes[chartId] = mode;
                
                const labels = historicalData.map(d => d.time);
                if (charts[chartId]) {
                    updateChart(charts[chartId], labels, chartId, mode);
                }
            });
        });

        function init() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const themeBtn = document.getElementById('themeBtn');
                if (themeBtn) {
                    themeBtn.textContent = '‚òÄÔ∏è Light';
                }
            }
           // connectWebSocket();
            initCharts();
            initSparklines();
            
            updateDashboard().then(() => {
                generateInsights();
            }).catch(err => {
                console.error('Initial update failed:', err);
            });
            
            intervalId = setInterval(() => {
                updateDashboard().catch(err => console.error('Update error:', err));
            }, updateInterval);
            
            insightsIntervalId = setInterval(generateInsights, 15000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>